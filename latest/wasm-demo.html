<html>

<head>
</head>

<body>
    <h1>This demo is being implemented!</h1>
    <p>
        It actually works, but if you don't plan on working via the web console there is not much to see :D.<br />
        Please come back later :)
    </p>
    <script type="module">
        import { WASI, File, OpenFile, ConsoleStdout, PreopenDirectory } from "https://unpkg.com/@bjorn3/browser_wasi_shim@0.3.0/dist";

        let args = ["bin", "template.xml", "data.xml"];
        let env = ["FOO=bar"];
        let fds = [
            new OpenFile(new File([])), // stdin
            ConsoleStdout.lineBuffered(msg => console.log(`[WASI stdout] ${msg}`)),
            ConsoleStdout.lineBuffered(msg => console.warn(`[WASI stderr] ${msg}`)),
            new PreopenDirectory(".", [
                ["data.xml", new File(new TextEncoder("utf-8").encode(`<a></a>`))],
                ["template.xml", new File(new TextEncoder("utf-8").encode(`<b></b>`))],
            ]),
        ];
        let wasi = new WASI(args, env, fds);
        console.log(wasi)
        const data = new Uint8Array(await (await fetch("https://github.com/lazy-eggplant/vs.templ/releases/latest/download/vs.templ.js")).arrayBuffer())

        const res = new Response(data, { headers: [["Content-Type", "application/wasm"]] })
        const module = new WebAssembly.Module(data);
        const instance = new WebAssembly.Instance(module, {
            "wasi_snapshot_preview1": wasi.wasiImport
        });
        console.log(instance);
        //console.log(instance.exports.process("<a></a>", "<b></b>"));
        wasi.start(instance);
    </script>
</body>

</html>